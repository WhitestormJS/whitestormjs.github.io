"use strict";var transferableMessage=self.webkitPostMessage||self.postMessage,MESSAGE_TYPES={WORLDREPORT:0,COLLISIONREPORT:1,VEHICLEREPORT:2,CONSTRAINTREPORT:3},_object,_vector,_transform,public_functions={},getShapeFromCache,setShapeCache,createShape,reportWorld,reportVehicles,reportCollisions,reportConstraints,fixedTimeStep,rateLimit,last_simulation_time,last_simulation_duration=0,world,transform,_vec3_1,_vec3_2,_vec3_3,_quat,_objects={},_vehicles={},_constraints={},_materials={},_objects_ammo={},_num_objects=0,_num_wheels=0,_num_constraints=0,_object_shapes={},_motion_states={},_noncached_shapes={},_compound_shapes={},REPORT_CHUNKSIZE,WORLDREPORT_ITEMSIZE=14,worldreport,COLLISIONREPORT_ITEMSIZE=5,collisionreport,VEHICLEREPORT_ITEMSIZE=9,vehiclereport,CONSTRAINTREPORT_ITEMSIZE=6,constraintreport,ab=new ArrayBuffer(1);transferableMessage(ab,[ab]);var SUPPORT_TRANSFERABLE=0===ab.byteLength;getShapeFromCache=function(e){return void 0!==_object_shapes[e]?_object_shapes[e]:null},setShapeCache=function(e,t){_object_shapes[e]=t},createShape=function(e){var t,o;switch(_transform.setIdentity(),e.type){case"plane":t="plane_"+e.normal.x+"_"+e.normal.y+"_"+e.normal.z,null===(o=getShapeFromCache(t))&&(_vec3_1.setX(e.normal.x),_vec3_1.setY(e.normal.y),_vec3_1.setZ(e.normal.z),o=new Ammo.btStaticPlaneShape(_vec3_1,0),setShapeCache(t,o));break;case"box":t="box_"+e.width+"_"+e.height+"_"+e.depth,null===(o=getShapeFromCache(t))&&(_vec3_1.setX(e.width/2),_vec3_1.setY(e.height/2),_vec3_1.setZ(e.depth/2),o=new Ammo.btBoxShape(_vec3_1),setShapeCache(t,o));break;case"sphere":t="sphere_"+e.radius,null===(o=getShapeFromCache(t))&&(o=new Ammo.btSphereShape(e.radius),setShapeCache(t,o));break;case"cylinder":t="cylinder_"+e.width+"_"+e.height+"_"+e.depth,null===(o=getShapeFromCache(t))&&(_vec3_1.setX(e.width/2),_vec3_1.setY(e.height/2),_vec3_1.setZ(e.depth/2),o=new Ammo.btCylinderShape(_vec3_1),setShapeCache(t,o));break;case"capsule":t="capsule_"+e.radius+"_"+e.height,null===(o=getShapeFromCache(t))&&(o=new Ammo.btCapsuleShape(e.radius,e.height-2*e.radius),setShapeCache(t,o));break;case"cone":t="cone_"+e.radius+"_"+e.height,null===(o=getShapeFromCache(t))&&(o=new Ammo.btConeShape(e.radius,e.height),setShapeCache(t,o));break;case"concave":var i,s,n=new Ammo.btTriangleMesh;if(!e.triangles.length)return!1;for(i=0;i<e.triangles.length;i++)s=e.triangles[i],_vec3_1.setX(s[0].x),_vec3_1.setY(s[0].y),_vec3_1.setZ(s[0].z),_vec3_2.setX(s[1].x),_vec3_2.setY(s[1].y),_vec3_2.setZ(s[1].z),_vec3_3.setX(s[2].x),_vec3_3.setY(s[2].y),_vec3_3.setZ(s[2].z),n.addTriangle(_vec3_1,_vec3_2,_vec3_3,!0);o=new Ammo.btBvhTriangleMeshShape(n,!0,!0),_noncached_shapes[e.id]=o;break;case"convex":var i,a,o=new Ammo.btConvexHullShape;for(i=0;i<e.points.length;i++)a=e.points[i],_vec3_1.setX(a.x),_vec3_1.setY(a.y),_vec3_1.setZ(a.z),o.addPoint(_vec3_1);_noncached_shapes[e.id]=o;break;case"heightfield":for(var _=Ammo._malloc(4*e.xpts*e.ypts),r=0,c=0,i=0;i<e.xpts;i++)for(var l=0;l<e.ypts;l++)Ammo.HEAPF32[_+c>>2]=e.points[r],r++,c+=4;o=new Ammo.btHeightfieldTerrainShape(e.xpts,e.ypts,_,1,-e.absMaxHeight,e.absMaxHeight,2,"PHY_FLOAT",!1),_vec3_1.setX(e.xsize/(e.xpts-1)),_vec3_1.setY(e.ysize/(e.ypts-1)),_vec3_1.setZ(1),o.setLocalScaling(_vec3_1),_noncached_shapes[e.id]=o;break;default:return}return o},public_functions.init=function(e){importScripts(e.ammo),_transform=new Ammo.btTransform,_vec3_1=new Ammo.btVector3(0,0,0),_vec3_2=new Ammo.btVector3(0,0,0),_vec3_3=new Ammo.btVector3(0,0,0),_quat=new Ammo.btQuaternion(0,0,0,0),REPORT_CHUNKSIZE=e.reportsize||50,SUPPORT_TRANSFERABLE?(worldreport=new Float32Array(2+REPORT_CHUNKSIZE*WORLDREPORT_ITEMSIZE),collisionreport=new Float32Array(2+REPORT_CHUNKSIZE*COLLISIONREPORT_ITEMSIZE),vehiclereport=new Float32Array(2+REPORT_CHUNKSIZE*VEHICLEREPORT_ITEMSIZE),constraintreport=new Float32Array(2+REPORT_CHUNKSIZE*CONSTRAINTREPORT_ITEMSIZE)):(worldreport=[],collisionreport=[],vehiclereport=[],constraintreport=[]),worldreport[0]=MESSAGE_TYPES.WORLDREPORT,collisionreport[0]=MESSAGE_TYPES.COLLISIONREPORT,vehiclereport[0]=MESSAGE_TYPES.VEHICLEREPORT,constraintreport[0]=MESSAGE_TYPES.CONSTRAINTREPORT;var t,o=new Ammo.btDefaultCollisionConfiguration,i=new Ammo.btCollisionDispatcher(o),s=new Ammo.btSequentialImpulseConstraintSolver;switch(e.broadphase||(e.broadphase={type:"dynamic"}),e.broadphase.type){case"sweepprune":_vec3_1.setX(e.broadphase.aabbmin.x),_vec3_1.setY(e.broadphase.aabbmin.y),_vec3_1.setZ(e.broadphase.aabbmin.z),_vec3_2.setX(e.broadphase.aabbmax.x),_vec3_2.setY(e.broadphase.aabbmax.y),_vec3_2.setZ(e.broadphase.aabbmax.z),t=new Ammo.btAxisSweep3(_vec3_1,_vec3_2);break;case"dynamic":default:t=new Ammo.btDbvtBroadphase}world=new Ammo.btDiscreteDynamicsWorld(i,t,s,o),fixedTimeStep=e.fixedTimeStep,rateLimit=e.rateLimit,transferableMessage({cmd:"worldReady"})},public_functions.registerMaterial=function(e){_materials[e.id]=e},public_functions.unRegisterMaterial=function(e){delete _materials[e.id]},public_functions.setFixedTimeStep=function(e){fixedTimeStep=e},public_functions.setGravity=function(e){_vec3_1.setX(e.x),_vec3_1.setY(e.y),_vec3_1.setZ(e.z),world.setGravity(_vec3_1)},public_functions.addObject=function(e){var t,o,i,s,n;if(o=createShape(e)){if(e.children){var a,_=new Ammo.btCompoundShape;for(_.addChildShape(_transform,o),t=0;t<e.children.length;t++){a=e.children[t];var r=new Ammo.btTransform;r.setIdentity(),_vec3_1.setX(a.position_offset.x),_vec3_1.setY(a.position_offset.y),_vec3_1.setZ(a.position_offset.z),r.setOrigin(_vec3_1),_quat.setX(a.rotation.x),_quat.setY(a.rotation.y),_quat.setZ(a.rotation.z),_quat.setW(a.rotation.w),r.setRotation(_quat),o=createShape(e.children[t]),_.addChildShape(r,o),Ammo.destroy(r)}o=_,_compound_shapes[e.id]=o}_vec3_1.setX(0),_vec3_1.setY(0),_vec3_1.setZ(0),o.calculateLocalInertia(e.mass,_vec3_1),_transform.setIdentity(),_vec3_2.setX(e.position.x),_vec3_2.setY(e.position.y),_vec3_2.setZ(e.position.z),_transform.setOrigin(_vec3_2),_quat.setX(e.rotation.x),_quat.setY(e.rotation.y),_quat.setZ(e.rotation.z),_quat.setW(e.rotation.w),_transform.setRotation(_quat),i=new Ammo.btDefaultMotionState(_transform),s=new Ammo.btRigidBodyConstructionInfo(e.mass,i,o,_vec3_1),void 0!==e.materialId&&(s.set_m_friction(_materials[e.materialId].friction),s.set_m_restitution(_materials[e.materialId].restitution)),n=new Ammo.btRigidBody(s),Ammo.destroy(s),"undefined"!=typeof e.collision_flags&&n.setCollisionFlags(e.collision_flags),world.addRigidBody(n),n.id=e.id,_objects[n.id]=n,_motion_states[n.id]=i;var c=void 0!=n.a?n.a:n.ptr;_objects_ammo[c]=n.id,_num_objects++,transferableMessage({cmd:"objectReady",params:n.id})}},public_functions.addVehicle=function(e){var t,o=new Ammo.btVehicleTuning;o.set_m_suspensionStiffness(e.suspension_stiffness),o.set_m_suspensionCompression(e.suspension_compression),o.set_m_suspensionDamping(e.suspension_damping),o.set_m_maxSuspensionTravelCm(e.max_suspension_travel),o.set_m_maxSuspensionForce(e.max_suspension_force),t=new Ammo.btRaycastVehicle(o,_objects[e.rigidBody],new Ammo.btDefaultVehicleRaycaster(world)),t.tuning=o,_objects[e.rigidBody].setActivationState(4),t.setCoordinateSystem(0,1,2),world.addVehicle(t),_vehicles[e.id]=t},public_functions.removeVehicle=function(e){delete _vehicles[e.id]},public_functions.addWheel=function(e){if(void 0!==_vehicles[e.id]){var t=_vehicles[e.id].tuning;void 0!==e.tuning&&(t=new Ammo.btVehicleTuning,t.set_m_suspensionStiffness(e.tuning.suspension_stiffness),t.set_m_suspensionCompression(e.tuning.suspension_compression),t.set_m_suspensionDamping(e.tuning.suspension_damping),t.set_m_maxSuspensionTravelCm(e.tuning.max_suspension_travel),t.set_m_maxSuspensionForce(e.tuning.max_suspension_force)),_vec3_1.setX(e.connection_point.x),_vec3_1.setY(e.connection_point.y),_vec3_1.setZ(e.connection_point.z),_vec3_2.setX(e.wheel_direction.x),_vec3_2.setY(e.wheel_direction.y),_vec3_2.setZ(e.wheel_direction.z),_vec3_3.setX(e.wheel_axle.x),_vec3_3.setY(e.wheel_axle.y),_vec3_3.setZ(e.wheel_axle.z),_vehicles[e.id].addWheel(_vec3_1,_vec3_2,_vec3_3,e.suspension_rest_length,e.wheel_radius,t,e.is_front_wheel)}_num_wheels++,SUPPORT_TRANSFERABLE?(vehiclereport=new Float32Array(1+_num_wheels*VEHICLEREPORT_ITEMSIZE),vehiclereport[0]=MESSAGE_TYPES.VEHICLEREPORT):vehiclereport=[MESSAGE_TYPES.VEHICLEREPORT]},public_functions.setSteering=function(e){void 0!==_vehicles[e.id]&&_vehicles[e.id].setSteeringValue(e.steering,e.wheel)},public_functions.setBrake=function(e){void 0!==_vehicles[e.id]&&_vehicles[e.id].setBrake(e.brake,e.wheel)},public_functions.applyEngineForce=function(e){void 0!==_vehicles[e.id]&&_vehicles[e.id].applyEngineForce(e.force,e.wheel)},public_functions.removeObject=function(e){world.removeRigidBody(_objects[e.id]),Ammo.destroy(_objects[e.id]),Ammo.destroy(_motion_states[e.id]),_compound_shapes[e.id]&&Ammo.destroy(_compound_shapes[e.id]),_noncached_shapes[e.id]&&Ammo.destroy(_noncached_shapes[e.id]);var t=void 0!=_objects[e.id].a?_objects[e.id].a:_objects[e.id].ptr;delete _objects_ammo[t],delete _objects[e.id],delete _motion_states[e.id],_compound_shapes[e.id]&&delete _compound_shapes[e.id],_noncached_shapes[e.id]&&delete _noncached_shapes[e.id],_num_objects--},public_functions.updateTransform=function(e){_object=_objects[e.id],_object.getMotionState().getWorldTransform(_transform),e.pos&&(_vec3_1.setX(e.pos.x),_vec3_1.setY(e.pos.y),_vec3_1.setZ(e.pos.z),_transform.setOrigin(_vec3_1)),e.quat&&(_quat.setX(e.quat.x),_quat.setY(e.quat.y),_quat.setZ(e.quat.z),_quat.setW(e.quat.w),_transform.setRotation(_quat)),_object.setWorldTransform(_transform),_object.activate()},public_functions.updateMass=function(e){_object=_objects[e.id],world.removeRigidBody(_object),_vec3_1.setX(0),_vec3_1.setY(0),_vec3_1.setZ(0),_object.setMassProps(e.mass,_vec3_1),world.addRigidBody(_object),_object.activate()},public_functions.applyCentralImpulse=function(e){_vec3_1.setX(e.x),_vec3_1.setY(e.y),_vec3_1.setZ(e.z),_objects[e.id].applyCentralImpulse(_vec3_1),_objects[e.id].activate()},public_functions.applyImpulse=function(e){_vec3_1.setX(e.impulse_x),_vec3_1.setY(e.impulse_y),_vec3_1.setZ(e.impulse_z),_vec3_2.setX(e.x),_vec3_2.setY(e.y),_vec3_2.setZ(e.z),_objects[e.id].applyImpulse(_vec3_1,_vec3_2),_objects[e.id].activate()},public_functions.applyTorque=function(e){_vec3_1.setX(e.torque_x),_vec3_1.setY(e.torque_y),_vec3_1.setZ(e.torque_z),_objects[e.id].applyTorque(_vec3_1),_objects[e.id].activate()},public_functions.applyCentralForce=function(e){_vec3_1.setX(e.x),_vec3_1.setY(e.y),_vec3_1.setZ(e.z),_objects[e.id].applyCentralForce(_vec3_1),_objects[e.id].activate()},public_functions.applyForce=function(e){_vec3_1.setX(e.force_x),_vec3_1.setY(e.force_y),_vec3_1.setZ(e.force_z),_vec3_2.setX(e.x),_vec3_2.setY(e.y),_vec3_2.setZ(e.z),_objects[e.id].applyForce(_vec3_1,_vec3_2),_objects[e.id].activate()},public_functions.onSimulationResume=function(e){last_simulation_time=Date.now()},public_functions.setAngularVelocity=function(e){_vec3_1.setX(e.x),_vec3_1.setY(e.y),_vec3_1.setZ(e.z),_objects[e.id].setAngularVelocity(_vec3_1),_objects[e.id].activate()},public_functions.setLinearVelocity=function(e){_vec3_1.setX(e.x),_vec3_1.setY(e.y),_vec3_1.setZ(e.z),_objects[e.id].setLinearVelocity(_vec3_1),_objects[e.id].activate()},public_functions.setAngularFactor=function(e){_vec3_1.setX(e.x),_vec3_1.setY(e.y),_vec3_1.setZ(e.z),_objects[e.id].setAngularFactor(_vec3_1)},public_functions.setLinearFactor=function(e){_vec3_1.setX(e.x),_vec3_1.setY(e.y),_vec3_1.setZ(e.z),_objects[e.id].setLinearFactor(_vec3_1)},public_functions.setDamping=function(e){_objects[e.id].setDamping(e.linear,e.angular)},public_functions.setCcdMotionThreshold=function(e){_objects[e.id].setCcdMotionThreshold(e.threshold)},public_functions.setCcdSweptSphereRadius=function(e){_objects[e.id].setCcdSweptSphereRadius(e.radius)},public_functions.addConstraint=function(e){var t;switch(e.type){case"point":void 0===e.objectb?(_vec3_1.setX(e.positiona.x),_vec3_1.setY(e.positiona.y),_vec3_1.setZ(e.positiona.z),t=new Ammo.btPoint2PointConstraint(_objects[e.objecta],_vec3_1)):(_vec3_1.setX(e.positiona.x),_vec3_1.setY(e.positiona.y),_vec3_1.setZ(e.positiona.z),_vec3_2.setX(e.positionb.x),_vec3_2.setY(e.positionb.y),_vec3_2.setZ(e.positionb.z),t=new Ammo.btPoint2PointConstraint(_objects[e.objecta],_objects[e.objectb],_vec3_1,_vec3_2));break;case"hinge":void 0===e.objectb?(_vec3_1.setX(e.positiona.x),_vec3_1.setY(e.positiona.y),_vec3_1.setZ(e.positiona.z),_vec3_2.setX(e.axis.x),_vec3_2.setY(e.axis.y),_vec3_2.setZ(e.axis.z),t=new Ammo.btHingeConstraint(_objects[e.objecta],_vec3_1,_vec3_2)):(_vec3_1.setX(e.positiona.x),_vec3_1.setY(e.positiona.y),_vec3_1.setZ(e.positiona.z),_vec3_2.setX(e.positionb.x),_vec3_2.setY(e.positionb.y),_vec3_2.setZ(e.positionb.z),_vec3_3.setX(e.axis.x),_vec3_3.setY(e.axis.y),_vec3_3.setZ(e.axis.z),t=new Ammo.btHingeConstraint(_objects[e.objecta],_objects[e.objectb],_vec3_1,_vec3_2,_vec3_3,_vec3_3));break;case"slider":var o,i,s;o=new Ammo.btTransform,_vec3_1.setX(e.positiona.x),_vec3_1.setY(e.positiona.y),_vec3_1.setZ(e.positiona.z),o.setOrigin(_vec3_1);var s=o.getRotation();s.setEuler(e.axis.x,e.axis.y,e.axis.z),o.setRotation(s),e.objectb?(i=new Ammo.btTransform,_vec3_2.setX(e.positionb.x),_vec3_2.setY(e.positionb.y),_vec3_2.setZ(e.positionb.z),i.setOrigin(_vec3_2),s=i.getRotation(),s.setEuler(e.axis.x,e.axis.y,e.axis.z),i.setRotation(s),t=new Ammo.btSliderConstraint(_objects[e.objecta],_objects[e.objectb],o,i,!0)):t=new Ammo.btSliderConstraint(_objects[e.objecta],o,!0),Ammo.destroy(o),void 0!=i&&Ammo.destroy(i);break;case"conetwist":var o,i;o=new Ammo.btTransform,o.setIdentity(),i=new Ammo.btTransform,i.setIdentity(),_vec3_1.setX(e.positiona.x),_vec3_1.setY(e.positiona.y),_vec3_1.setZ(e.positiona.z),_vec3_2.setX(e.positionb.x),_vec3_2.setY(e.positionb.y),_vec3_2.setZ(e.positionb.z),o.setOrigin(_vec3_1),i.setOrigin(_vec3_2);var s=o.getRotation();s.setEulerZYX(-e.axisa.z,-e.axisa.y,-e.axisa.x),o.setRotation(s),s=i.getRotation(),s.setEulerZYX(-e.axisb.z,-e.axisb.y,-e.axisb.x),i.setRotation(s),t=new Ammo.btConeTwistConstraint(_objects[e.objecta],_objects[e.objectb],o,i),t.setLimit(Math.PI,0,Math.PI),Ammo.destroy(o),Ammo.destroy(i);break;case"dof":var o,i,s;o=new Ammo.btTransform,o.setIdentity(),_vec3_1.setX(e.positiona.x),_vec3_1.setY(e.positiona.y),_vec3_1.setZ(e.positiona.z),o.setOrigin(_vec3_1),s=o.getRotation(),s.setEulerZYX(-e.axisa.z,-e.axisa.y,-e.axisa.x),o.setRotation(s),e.objectb?(i=new Ammo.btTransform,i.setIdentity(),_vec3_2.setX(e.positionb.x),_vec3_2.setY(e.positionb.y),_vec3_2.setZ(e.positionb.z),i.setOrigin(_vec3_2),s=i.getRotation(),s.setEulerZYX(-e.axisb.z,-e.axisb.y,-e.axisb.x),i.setRotation(s),t=new Ammo.btGeneric6DofConstraint(_objects[e.objecta],_objects[e.objectb],o,i,!0)):t=new Ammo.btGeneric6DofConstraint(_objects[e.objecta],o,!0),Ammo.destroy(o),void 0!=i&&Ammo.destroy(i);break;default:return}world.addConstraint(t),t.a=_objects[e.objecta],t.b=_objects[e.objectb],t.ta=o,t.tb=i,t.enableFeedback(),_constraints[e.id]=t,_num_constraints++,SUPPORT_TRANSFERABLE?(constraintreport=new Float32Array(1+_num_constraints*CONSTRAINTREPORT_ITEMSIZE),constraintreport[0]=MESSAGE_TYPES.CONSTRAINTREPORT):constraintreport=[MESSAGE_TYPES.CONSTRAINTREPORT]},public_functions.removeConstraint=function(e){var t=_constraints[e.id];void 0!==t&&(world.removeConstraint(t),delete _constraints[e.id],_num_constraints--)},public_functions.constraint_setBreakingImpulseThreshold=function(e){var t=_constraints[e.id];t!==undefind&&t.setBreakingImpulseThreshold(e.threshold)},public_functions.simulate=function(e){if(world){if(e=e||{},e.timeStep)e.timeStep<fixedTimeStep&&(e.timeStep=fixedTimeStep);else if(last_simulation_time)for(e.timeStep=0;e.timeStep+last_simulation_duration<=fixedTimeStep;)e.timeStep=(Date.now()-last_simulation_time)/1e3;else e.timeStep=fixedTimeStep;e.maxSubSteps=e.maxSubSteps||Math.ceil(e.timeStep/fixedTimeStep),last_simulation_duration=Date.now(),world.stepSimulation(e.timeStep,e.maxSubSteps,fixedTimeStep),reportVehicles(),reportCollisions(),reportConstraints(),reportWorld(),last_simulation_duration=(Date.now()-last_simulation_duration)/1e3,last_simulation_time=Date.now()}},public_functions.hinge_setLimits=function(e){_constraints[e.constraint].setLimit(e.low,e.high,0,e.bias_factor,e.relaxation_factor)},public_functions.hinge_enableAngularMotor=function(e){var t=_constraints[e.constraint];t.enableAngularMotor(!0,e.velocity,e.acceleration),t.a.activate(),t.b&&t.b.activate()},public_functions.hinge_disableMotor=function(e){_constraints[e.constraint].enableMotor(!1),constraint.b&&constraint.b.activate()},public_functions.slider_setLimits=function(e){var t=_constraints[e.constraint];t.setLowerLinLimit(e.lin_lower||0),t.setUpperLinLimit(e.lin_upper||0),t.setLowerAngLimit(e.ang_lower||0),t.setUpperAngLimit(e.ang_upper||0)},public_functions.slider_setRestitution=function(e){var t=_constraints[e.constraint];t.setSoftnessLimLin(e.linear||0),t.setSoftnessLimAng(e.angular||0)},public_functions.slider_enableLinearMotor=function(e){var t=_constraints[e.constraint];t.setTargetLinMotorVelocity(e.velocity),t.setMaxLinMotorForce(e.acceleration),t.setPoweredLinMotor(!0),t.a.activate(),t.b&&t.b.activate()},public_functions.slider_disableLinearMotor=function(e){var t=_constraints[e.constraint];t.setPoweredLinMotor(!1),t.b&&t.b.activate()},public_functions.slider_enableAngularMotor=function(e){var t=_constraints[e.constraint];t.setTargetAngMotorVelocity(e.velocity),t.setMaxAngMotorForce(e.acceleration),t.setPoweredAngMotor(!0),t.a.activate(),t.b&&t.b.activate()},public_functions.slider_disableAngularMotor=function(e){var t=_constraints[e.constraint];t.setPoweredAngMotor(!1),t.a.activate(),t.b&&t.b.activate()},public_functions.conetwist_setLimit=function(e){_constraints[e.constraint].setLimit(e.z,e.y,e.x)},public_functions.conetwist_enableMotor=function(e){var t=_constraints[e.constraint];t.enableMotor(!0),t.a.activate(),t.b.activate()},public_functions.conetwist_setMaxMotorImpulse=function(e){var t=_constraints[e.constraint];t.setMaxMotorImpulse(e.max_impulse),t.a.activate(),t.b.activate()},public_functions.conetwist_setMotorTarget=function(e){var t=_constraints[e.constraint];_quat.setX(e.x),_quat.setY(e.y),_quat.setZ(e.z),_quat.setW(e.w),t.setMotorTarget(_quat),t.a.activate(),t.b.activate()},public_functions.conetwist_disableMotor=function(e){var t=_constraints[e.constraint];t.enableMotor(!1),t.a.activate(),t.b.activate()},public_functions.dof_setLinearLowerLimit=function(e){var t=_constraints[e.constraint];_vec3_1.setX(e.x),_vec3_1.setY(e.y),_vec3_1.setZ(e.z),t.setLinearLowerLimit(_vec3_1),t.a.activate(),t.b&&t.b.activate()},public_functions.dof_setLinearUpperLimit=function(e){var t=_constraints[e.constraint];_vec3_1.setX(e.x),_vec3_1.setY(e.y),_vec3_1.setZ(e.z),t.setLinearUpperLimit(_vec3_1),t.a.activate(),t.b&&t.b.activate()},public_functions.dof_setAngularLowerLimit=function(e){var t=_constraints[e.constraint];_vec3_1.setX(e.x),_vec3_1.setY(e.y),_vec3_1.setZ(e.z),t.setAngularLowerLimit(_vec3_1),t.a.activate(),t.b&&t.b.activate()},public_functions.dof_setAngularUpperLimit=function(e){var t=_constraints[e.constraint];_vec3_1.setX(e.x),_vec3_1.setY(e.y),_vec3_1.setZ(e.z),t.setAngularUpperLimit(_vec3_1),t.a.activate(),t.b&&t.b.activate()},public_functions.dof_enableAngularMotor=function(e){var t=_constraints[e.constraint],o=t.getRotationalLimitMotor(e.which);o.set_m_enableMotor(!0),t.a.activate(),t.b&&t.b.activate()},public_functions.dof_configureAngularMotor=function(e){var t=_constraints[e.constraint],o=t.getRotationalLimitMotor(e.which);o.set_m_loLimit(e.low_angle),console.log(o.get_m_targetVelocity()),o.set_m_hiLimit(e.high_angle),o.set_m_targetVelocity(e.velocity),o.set_m_maxMotorForce(e.max_force),t.a.activate(),t.b&&t.b.activate()},public_functions.dof_disableAngularMotor=function(e){var t=_constraints[e.constraint],o=t.getRotationalLimitMotor(e.which);o.set_m_enableMotor(!1),t.a.activate(),t.b&&t.b.activate()},reportWorld=function(){var e,t,o,i,s,n=0,a=0;SUPPORT_TRANSFERABLE&&worldreport.length<2+_num_objects*WORLDREPORT_ITEMSIZE&&(worldreport=new Float32Array(2+Math.ceil(_num_objects/REPORT_CHUNKSIZE)*REPORT_CHUNKSIZE*WORLDREPORT_ITEMSIZE),worldreport[0]=MESSAGE_TYPES.WORLDREPORT),worldreport[1]=_num_objects;for(e in _objects)_objects.hasOwnProperty(e)&&(t=_objects[e],o=t.getCenterOfMassTransform(),i=o.getOrigin(),s=o.getRotation(),n=2+a++*WORLDREPORT_ITEMSIZE,worldreport[n]=t.id,worldreport[n+1]=i.x(),worldreport[n+2]=i.y(),worldreport[n+3]=i.z(),worldreport[n+4]=s.x(),worldreport[n+5]=s.y(),worldreport[n+6]=s.z(),worldreport[n+7]=s.w(),_vector=t.getLinearVelocity(),worldreport[n+8]=_vector.x(),worldreport[n+9]=_vector.y(),worldreport[n+10]=_vector.z(),_vector=t.getAngularVelocity(),worldreport[n+11]=_vector.x(),worldreport[n+12]=_vector.y(),worldreport[n+13]=_vector.z());SUPPORT_TRANSFERABLE?transferableMessage(worldreport.buffer,[worldreport.buffer]):transferableMessage(worldreport)},reportCollisions=function(){var e,t,o,i,s,n,a=world.getDispatcher(),_=a.getNumManifolds();for(SUPPORT_TRANSFERABLE&&collisionreport.length<2+_*COLLISIONREPORT_ITEMSIZE&&(collisionreport=new Float32Array(2+Math.ceil(_num_objects/REPORT_CHUNKSIZE)*REPORT_CHUNKSIZE*COLLISIONREPORT_ITEMSIZE),collisionreport[0]=MESSAGE_TYPES.COLLISIONREPORT),collisionreport[1]=0,e=0;_>e;e++)if(o=a.getManifoldByIndexInternal(e),i=o.getNumContacts(),0!==i)for(s=0;i>s;s++){n=o.getContactPoint(s),t=2+collisionreport[1]++*COLLISIONREPORT_ITEMSIZE,collisionreport[t]=_objects_ammo[o.getBody0().ptr],collisionreport[t+1]=_objects_ammo[o.getBody1().ptr],_vector=n.get_m_normalWorldOnB(),collisionreport[t+2]=_vector.x(),collisionreport[t+3]=_vector.y(),collisionreport[t+4]=_vector.z();break}SUPPORT_TRANSFERABLE?transferableMessage(collisionreport.buffer,[collisionreport.buffer]):transferableMessage(collisionreport)},reportVehicles=function(){var e,t,o,i,s,n=0,a=0,_=0;SUPPORT_TRANSFERABLE&&vehiclereport.length<2+_num_wheels*VEHICLEREPORT_ITEMSIZE&&(vehiclereport=new Float32Array(2+Math.ceil(_num_wheels/REPORT_CHUNKSIZE)*REPORT_CHUNKSIZE*VEHICLEREPORT_ITEMSIZE),vehiclereport[0]=MESSAGE_TYPES.VEHICLEREPORT);for(e in _vehicles)if(_vehicles.hasOwnProperty(e))for(t=_vehicles[e],_=0;_<t.getNumWheels();_++)o=t.getWheelInfo(_).get_m_worldTransform(),i=o.getOrigin(),s=o.getRotation(),n=1+a++*VEHICLEREPORT_ITEMSIZE,vehiclereport[n]=e,vehiclereport[n+1]=_,vehiclereport[n+2]=i.x(),vehiclereport[n+3]=i.y(),vehiclereport[n+4]=i.z(),vehiclereport[n+5]=s.x(),vehiclereport[n+6]=s.y(),vehiclereport[n+7]=s.z(),vehiclereport[n+8]=s.w();0!==_&&(SUPPORT_TRANSFERABLE?transferableMessage(vehiclereport.buffer,[vehiclereport.buffer]):transferableMessage(vehiclereport))},reportConstraints=function(){var e,t,o,i,s,n=0,a=0;SUPPORT_TRANSFERABLE&&constraintreport.length<2+_num_constraints*CONSTRAINTREPORT_ITEMSIZE&&(constraintreport=new Float32Array(2+Math.ceil(_num_constraints/REPORT_CHUNKSIZE)*REPORT_CHUNKSIZE*CONSTRAINTREPORT_ITEMSIZE),constraintreport[0]=MESSAGE_TYPES.CONSTRAINTREPORT);for(e in _constraints)_constraints.hasOwnProperty(e)&&(t=_constraints[e],o=t.a,i=t.ta,s=i.getOrigin(),n=1+a++*CONSTRAINTREPORT_ITEMSIZE,constraintreport[n]=e,constraintreport[n+1]=o.id,constraintreport[n+2]=s.x,constraintreport[n+3]=s.y,constraintreport[n+4]=s.z,constraintreport[n+5]=t.getBreakingImpulseThreshold());0!==a&&(SUPPORT_TRANSFERABLE?transferableMessage(constraintreport.buffer,[constraintreport.buffer]):transferableMessage(constraintreport))},self.onmessage=function(e){if(e.data instanceof Float32Array)switch(e.data[0]){case MESSAGE_TYPES.WORLDREPORT:worldreport=new Float32Array(e.data);break;case MESSAGE_TYPES.COLLISIONREPORT:collisionreport=new Float32Array(e.data);break;case MESSAGE_TYPES.VEHICLEREPORT:vehiclereport=new Float32Array(e.data);break;case MESSAGE_TYPES.CONSTRAINTREPORT:constraintreport=new Float32Array(e.data)}else e.data.cmd&&public_functions[e.data.cmd]&&public_functions[e.data.cmd](e.data.params)};